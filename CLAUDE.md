# Henry EMR ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ (v3.21)

## åºç« . AIå”åƒé–‹ç™ºã®ãƒ«ãƒ¼ãƒ« (AI Collaboration Protocol)

æœ¬ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«åŸºã¥ãã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹ç™ºã‚’AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¨å”åƒã§è¡Œã†éš›ã®ãƒ«ãƒ¼ãƒ«ã€‚

**å¯¾è±¡**: AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆClaude, Geminiç­‰ï¼‰

### æŒ‡ç¤ºã®ç¢ºèª

AIã¯æŒ‡ç¤ºã‚’å—ã‘ãŸã‚‰ã€ä½œæ¥­ã«å…¥ã‚‹å‰ã«ä»¥ä¸‹ã‚’è¡Œã†ï¼š

1. **ç†è§£å†…å®¹ã®èª¬æ˜** â€” æŒ‡ç¤ºã‚’ã©ã®ã‚ˆã†ã«è§£é‡ˆã—ãŸã‹ã‚’èª¬æ˜ã™ã‚‹
2. **ä¸æ˜ç‚¹ã®è³ªå•** â€” æ›–æ˜§ãªç‚¹ã‚„è¤‡æ•°ã®è§£é‡ˆãŒå¯èƒ½ãªç‚¹ãŒã‚ã‚Œã°è³ªå•ã™ã‚‹
3. **åˆæ„å¾Œã«ç€æ‰‹** â€” èªè­˜ãŒä¸€è‡´ã—ãŸã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ä½œæ¥­ã‚’é–‹å§‹ã™ã‚‹

### ã‚³ãƒ¼ãƒ‰å‡ºåŠ›ã®åˆ¶ç´„ (Code Generation Protocol) ã€é‡è¦ã€‘

**åŸå‰‡**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®æ˜ç¤ºçš„ãªæŒ‡ç¤ºï¼ˆä¾‹ï¼šã€Œã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã€ã€Œå®Ÿè£…ã—ã¦ã€ï¼‰ãŒã‚ã‚‹ã¾ã§ã€ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã®ã¾ã¾ä½¿ãˆã‚‹ã€Œå®Œå…¨ãªå®Ÿè£…ã‚³ãƒ¼ãƒ‰ã€ã‚’å‡ºåŠ›ã—ã¦ã¯ãªã‚‰ãªã„ã€‚

**ç¦æ­¢äº‹é …**: è­°è«–ã®é€”ä¸­ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±‚ã‚ã¦ã„ãªã„ã®ã«ã€Œä¿®æ­£ã—ãŸå…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã§ã™ã€ã¨é•·ã„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æç¤ºã™ã‚‹ã“ã¨ã€‚

**ä¾‹å¤–ï¼ˆè¨±å¯ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ï¼‰**: ãƒ­ã‚¸ãƒƒã‚¯ã‚„å‡¦ç†ã®æµã‚Œã‚’èª¬æ˜ã™ã‚‹ãŸã‚ã®çŸ­ã„ã‚³ãƒ¼ãƒ‰ç‰‡ï¼ˆæ•°è¡Œç¨‹åº¦ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆï¼‰ã‚„ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã¯ã€ç†è§£ã‚’åŠ©ã‘ã‚‹ãŸã‚ã«ç©æ¥µçš„ã«æç¤ºã—ã¦ã‚ˆã„ã€‚

**åˆ¤æ–­åŸºæº–**:

- âœ… OK: ã€Œä¾‹ãˆã°ã€ã“ã®ã‚ˆã†ã« `filter` ã‚’ä½¿ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€ã¨ã„ã£ãŸèª¬æ˜ç”¨ã®æŠœç²‹
- âŒ NG: ã€Œä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€ã¨ã„ã£ãŸå®Œæˆå“ã®æç¤ºï¼ˆæŒ‡ç¤ºãŒã‚ã‚‹ã¾ã§å¾…æ©Ÿï¼‰

### ã‚³ãƒ¼ãƒ‰å‡ºåŠ›ã®é †åº (Code Output Order)

**åŸå‰‡**: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‡ºåŠ›ã™ã‚‹éš›ã¯ã€èª¬æ˜æ–‡ã‚’**å…ˆã«**ã€ã‚³ãƒ¼ãƒ‰ã‚’**æœ€å¾Œã«**é…ç½®ã™ã‚‹ã€‚ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å¾Œã«èª¬æ˜æ–‡ã‚’æ›¸ã‹ãªã„ã€‚

**ç†ç”±**: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®å¾Œã«èª¬æ˜æ–‡ãŒã‚ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚³ãƒ”ãƒšã™ã‚‹éš›ã«ä½™è¨ˆãªãƒ†ã‚­ã‚¹ãƒˆãŒæ··å…¥ã—ã€ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã‚‹ã€‚

**åˆ¤æ–­åŸºæº–**:

- âœ… OK: èª¬æ˜ â†’ å¤‰æ›´ç‚¹ â†’ ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆçµ‚äº†ï¼‰
- âŒ NG: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ â†’ å¤‰æ›´ç‚¹ â†’ èª¬æ˜

### ç›®çš„

- èªè­˜ã®ã‚ºãƒ¬ã«ã‚ˆã‚‹æ‰‹æˆ»ã‚Šã‚’é˜²ã
- æš—é»™ã®å‰æã‚’æ˜ç¤ºåŒ–ã™ã‚‹
- å…±é€šã®ç†è§£ã®ã‚‚ã¨ã§åŠ¹ç‡çš„ã«é€²ã‚ã‚‹
- ä¸è¦ãªé•·æ–‡ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ãƒ³æµªè²»ã¨å¯èª­æ€§ä½ä¸‹ã‚’é˜²ã
- ã€Œå®Ÿè£…ã€ã®å‰ã«ã€Œè¨­è¨ˆãƒ»åŸå› ç‰¹å®šã€ã‚’ç¢ºå®Ÿã«è¡Œã†

---

## 0. é©ç”¨ç¯„å›² (Target URL)

Henryé›»å­ã‚«ãƒ«ãƒ†ã®URLã¯ `https://henry-app.jp/â—¯â—¯` ã§æ§‹æˆã•ã‚Œã‚‹ã€‚

Userscriptã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã¯ä»¥ä¸‹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã€‚

```javascript
// @match https://henry-app.jp/*
```

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

å…¨ã¦ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆx.y.zï¼‰ã«å¾“ã†ã“ã¨ã€‚

Henry Core ã®ä»•æ§˜å¤‰æ›´ã«å¯¾å¿œã—ãŸå ´åˆã¯ã€å¿…ãšãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ã‚‹ï¼ˆä¾‹: ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ z ã®åŠ ç®—ï¼‰ã€‚

---

## 1. ã‚³ã‚¢ãƒ»ãƒãƒªã‚·ãƒ¼ (UX & Safety)

### éä¾µå…¥å‹UXã®å¾¹åº•

ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãªã—ã§ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¥ªå–ã¯å³ç¦ã€‚

### ã‚¹ãƒãƒ¼ãƒˆãƒ»ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ¶é™

ã€Œã¼ã‹ã—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã€ç­‰ã®è¦–è¦šåŠ¹æœã‚’ä¼´ã†ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯æ“ä½œã‚’èµ·ç‚¹ã¨ã™ã‚‹å ´åˆã®ã¿è¨±å¯ã™ã‚‹ã€‚

### åœæ­¢ã®åŸå‰‡ã¨ãƒ­ã‚°ã®åˆ‡ã‚Šåˆ†ã‘

| è¦–ç‚¹ | ãƒ«ãƒ¼ãƒ« |
|------|--------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–ç‚¹ | UIã‚’å‡ºã•ãªã„ã€æ“ä½œã‚’ç¶™ç¶šã•ã›ãªã„ï¼ˆæ²ˆé»™ã—ã¦åœæ­¢ï¼‰ |
| é–‹ç™ºè€…è¦–ç‚¹ | `console.error` ã§åŸå› ã‚’ç‰¹å®šå¯èƒ½ã«ã™ã‚‹ã€‚ãŸã ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ç­‰ã®ç§˜åŒ¿æƒ…å ±ã¯çµ¶å¯¾ã«ãƒ­ã‚°å‡ºåŠ›ã—ãªã„ |

**è£œè¶³ï¼šåœæ­¢ã®çµ±ä¸€ãƒ«ãƒ¼ãƒ«**

- APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚¨ãƒ©ãƒ¼ / æƒ³å®šå¤–ã®å½¢å¼ / null ã®å ´åˆã‚‚å³åœæ­¢ï¼ˆå†è©¦è¡Œã—ãªã„ï¼‰
- ã€Œé™ã‹ã«çµ‚äº†ã€= Promise ã¯ `resolve(null)` ã§æ­£å¸¸çµ‚äº†ã•ã›ã€å‘¼ã³å‡ºã—å…ƒã§ null ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†

### ãƒ­ã‚°å‡ºåŠ›ã®åŸå‰‡

- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«ã¯å¿…ãš `[SCRIPT_NAME]` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä»˜ã‘ã‚‹
- åŒä¸€ã‚¨ãƒ©ãƒ¼ã¯1å›ã ã‘å‡ºåŠ›ã™ã‚‹ï¼ˆãƒ«ãƒ¼ãƒ—å†…ã§ã®é€£æ‰“ç¦æ­¢ï¼‰

### PIIï¼ˆå€‹äººæƒ…å ±ï¼‰ã®æ°¸ç¶šåŒ–ç¦æ­¢ ã€é‡è¦ã€‘

`localStorage`, `IndexedDB`, `GM_setValue` ç­‰ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã€æ‚£è€…ã®æ°åãƒ»é€£çµ¡å…ˆãƒ»ã‚«ãƒ«ãƒ†å†…å®¹ãªã©ã®å€‹äººæƒ…å ±ã‚’å¹³æ–‡ã§ä¿å­˜ã™ã‚‹ã“ã¨ã‚’å³ç¦ã¨ã™ã‚‹ã€‚

ä¸€æ™‚çš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¿…è¦ãªå ´åˆã¯ã€ãƒ¡ãƒ¢ãƒªä¸Šã®å¤‰æ•°ï¼ˆTTLCacheãªã©ï¼‰ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚

### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

SPAé·ç§»æ™‚ï¼ˆ`henry:navigation` / `popstate`ï¼‰ã«ã¯ã€å…¨ã¦ã® MutationObserverã€ã‚¿ã‚¤ãƒãƒ¼ã€éåŒæœŸå‡¦ç†ï¼ˆAbortControllerï¼‰ã‚’å®Œå…¨ã«ç ´æ£„ã™ã‚‹ã€‚

#### æ¨™æº–ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šcreateCleaner

ç ´æ£„å¯¾è±¡ã®æ¼ã‚Œã‚’é˜²ããŸã‚ã€`HenryCore.utils.createCleaner()` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```javascript
const cleaner = HenryCore.utils.createCleaner();

// ç™»éŒ²ä¾‹
const timerId = setTimeout(fn, 1000);
cleaner.add(() => clearTimeout(timerId));

const observer = new MutationObserver(callback);
observer.observe(target, config);
cleaner.add(() => observer.disconnect());

// SPAé·ç§»æ™‚ã«ä¸€æ‹¬å®Ÿè¡Œ
cleaner.exec();
```

#### è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼šsubscribeNavigation

ç”»é¢é·ç§»ã®ãŸã³ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— â†’ å†åˆæœŸåŒ–ã‚’è‡ªå‹•ã§è¡Œã†å ´åˆï¼š

```javascript
const cleaner = HenryCore.utils.createCleaner();

HenryCore.utils.subscribeNavigation(cleaner, () => {
  // ã“ã“ã«åˆæœŸåŒ–å‡¦ç†ã‚’æ›¸ã
  // ç”»é¢é·ç§»æ™‚ã¯è‡ªå‹•ã§ cleaner.exec() â†’ ã“ã®é–¢æ•°ãŒå†å®Ÿè¡Œã•ã‚Œã‚‹
});
```

---

## 2. ã‚»ãƒ¬ã‚¯ã‚¿æˆ¦ç•¥ (Robust Selector)

### ä¸å¤‰å±æ€§ã®å„ªå…ˆ

`.sc-xxxx` ãªã©ã®ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¯ãƒ©ã‚¹åã‚„ XPath ã¯ä½¿ç”¨ç¦æ­¢ã€‚

**æ¨å¥¨**: `data-testid`ã€`role`ã€`aria-*` å±æ€§ã€ã¾ãŸã¯ä¸å¤‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åŸºæº–ã«ã™ã‚‹ã€‚

### ãƒãƒ¼ã‚¿ãƒ«è¦ç´ ã®è€ƒæ…®

ãƒ¢ãƒ¼ãƒ€ãƒ«ç­‰ã¯ `document.body` ç›´ä¸‹ã«ç¾ã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠå¤–ã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨±å®¹ã™ã‚‹è¨­è¨ˆã«ã™ã‚‹ã€‚

---

## 3. Henry API é‹ç”¨ãƒ«ãƒ¼ãƒ« (GraphQL)

DOMè§£æã‚’é¿ã‘ã€`window.HenryCore` ã‚’é€šã˜ãŸãƒ‡ãƒ¼ã‚¿æ“ä½œã‚’è¡Œã†ã€‚

### å‰ææ¡ä»¶

APIå‘¼ã³å‡ºã—ã«ã¯ã€ŒHenry Coreã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¿…è¦ã€‚ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ `window.HenryCore` ã‚’æä¾›ã™ã‚‹ã€‚

```javascript
// HenryCore ã®å¾…æ©Ÿï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
async function waitForHenryCore(timeout = 5000) {
  let waited = 0;
  while (!window.HenryCore) {
    await new Promise(r => setTimeout(r, 100));
    waited += 100;
    if (waited > timeout) {
      console.error('[SCRIPT_NAME] HenryCore ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return false;
    }
  }
  return true;
}
```

### åŸºæœ¬çš„ãªå‘¼ã³å‡ºã—

```javascript
const result = await HenryCore.call('GetPatient', {
  input: { uuid: patientUuid }
});

const patient = result.data?.getPatient;
if (!patient) return null; // é™ã‹ã«çµ‚äº†
```

### ãƒ˜ãƒƒãƒ€ãƒ¼è²¬å‹™

`Authorization` ãŠã‚ˆã³ `x-auth-organization-uuid` ã¯ `HenryCore.call` ãŒå†…éƒ¨ã§æ³¨å…¥ã™ã‚‹ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆå´ã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ„è­˜ã™ã‚‹å¿…è¦ã¯ãªã„ã€‚

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

`HenryCore.call()` ã¯å¤±æ•—æ™‚ã«ä¾‹å¤–ã‚’æŠ•ã’ã‚‹ã€‚

```javascript
try {
  const result = await HenryCore.call('GetPatient', { input: { uuid } });
  if (!result.data?.getPatient) return null;
  // æ­£å¸¸å‡¦ç†
} catch (e) {
  console.error('[SCRIPT_NAME]', e.message);
  return null;
}
```

### äºŒé‡é€ä¿¡é˜²æ­¢ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©ã‚¤ãƒˆãƒ­ãƒƒã‚¯ï¼‰

åŒä¸€ãƒªã‚½ãƒ¼ã‚¹ã¸ã®é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é˜²ãã«ã¯ `withLock` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

```javascript
const inflight = new Map();

async function fetchPatientOnce(uuid) {
  return HenryCore.utils.withLock(inflight, uuid, () =>
    HenryCore.call('GetPatient', { input: { uuid } })
      .then(r => r.data?.getPatient ?? null)
  );
}
```

---

## 4. HenryCore å‹å®šç¾© (Type Reference)

AIã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã®ç²¾åº¦ã‚’é«˜ã‚ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®å®šç¾©ã‚’å‚ç…§ã™ã‚‹ã“ã¨ã€‚

```typescript
/**
 * HenryCore Interface Definition (v2.6.0+)
 */
interface HenryCore {
  /**
   * GraphQL API å‘¼ã³å‡ºã— (è‡ªå‹•ãƒãƒƒã‚·ãƒ¥è§£æ±ºãƒ»ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæŒ¯åˆ†)
   * @throws {Error} ãƒãƒƒã‚·ãƒ¥æœªåé›†ã€ãƒˆãƒ¼ã‚¯ãƒ³åˆ‡ã‚Œã€é€šä¿¡ã‚¨ãƒ©ãƒ¼æ™‚
   */
  call<T = any>(operationName: string, variables: Record<string, any>): Promise<{ data: T }>;

  /**
   * è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼UUIDã‚’å–å¾— (é…å»¶å–å¾— + ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
   * åˆå›å‘¼ã³å‡ºã—æ™‚ã«APIã‚’å®Ÿè¡Œã€2å›ç›®ä»¥é™ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¿”ã™
   */
  getMyUuid(): Promise<string | null>;

  /**
   * HenryToolbox ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç™»éŒ² (æ¨å¥¨ãƒ¡ã‚½ãƒƒãƒ‰)
   * å†…éƒ¨ã§ Toolbox ã¨ register ãƒ¡ã‚½ãƒƒãƒ‰ã®å‡ºç¾ã‚’å¾…æ©Ÿã™ã‚‹
   */
  registerPlugin(options: { 
    label: string; 
    event: string; 
    order?: number; 
  }): Promise<boolean>;

  /** ç¾åœ¨è¡¨ç¤ºä¸­ã®æ‚£è€…UUID (fetch intercept) */
  getPatientUuid(): string | null;

  /** Firebase Auth ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— */
  getToken(): Promise<string | null>;

  /** åé›†æ¸ˆã¿ãƒãƒƒã‚·ãƒ¥ä¸€è¦§å–å¾— */
  getHashes(): Promise<Record<string, { hash: string, endpoint: string }>>;

  /** ãƒˆãƒ¼ã‚¯ãƒ³çŠ¶æ…‹ç¢ºèª */
  tokenStatus(): Promise<{ valid: boolean, expiration: Date, remainingMinutes: number } | null>;

  /** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ç¾¤ */
  utils: {
    createCleaner(): Cleaner;
    createLogger(name: string): Logger;
    waitForElement(selector: string, timeout?: number): Promise<HTMLElement | null>;
    waitForGlobal(key: string, timeout?: number): Promise<any>;
    /** Toolboxã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿ (registerPluginã®ä½¿ç”¨ã‚’æ¨å¥¨) */
    waitForToolbox(timeout?: number): Promise<any>;
    sleep(ms: number): Promise<void>;
    withLock<T>(map: Map<string, Promise<T>>, key: string, generator: () => Promise<T>): Promise<T>;
    subscribeNavigation(cleaner: Cleaner, initFn: () => void): void;
  };

  /** UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
  ui: {
    createButton(props: { 
      label: string; 
      variant?: 'primary' | 'secondary'; 
      icon?: string; 
      onClick?: () => void; 
    }): HTMLElement;
    
    showModal(props: { 
      title: string; 
      content: string | HTMLElement; 
      actions?: Array<{ label: string; variant?: string; onClick?: () => void }>; 
    }): { close: () => void };
  };
}
```

---

## 5. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & ãƒ‡ãƒãƒƒã‚°

### ãƒ­ã‚°å‡ºåŠ›ï¼šcreateLogger

```javascript
const log = HenryCore.utils.createLogger('MyScript');

log.info('å‡¦ç†é–‹å§‹');
log.warn('æ³¨æ„');
log.error('å¤±æ•—', error);  // error.message ã®ã¿å‡ºåŠ›ï¼ˆç§˜åŒ¿æƒ…å ±ä¿è­·ï¼‰
```

### è¦ç´ å¾…æ©Ÿï¼šwaitForElement

```javascript
const el = await HenryCore.utils.waitForElement('[data-testid="patient-name"]', 5000);
if (!el) return null; // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã¯ null
```

### ãƒ‡ãƒãƒƒã‚°æ‰‹é †ï¼ˆåŸå› ç©¶æ˜ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆï¼‰

1. **ç¾çŠ¶æŠŠæ¡**: ãƒ­ã‚°ã®ç¢ºèªã€ç„¡è¨€åœæ­¢ã®ç¢ºèª
2. **è¦å› åˆ‡ã‚Šåˆ†ã‘**: DOMå¤‰åŒ–ã€éåŒæœŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ
3. **ä»®èª¬æ¤œè¨¼**: æ ¹æ‹ ã®ã‚ã‚‹ä¿®æ­£ã®ã¿ã‚’è¡Œã†

---

## 6. å‹•çš„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—

### æ‚£è€…UUID: getPatientUuid

React ã®çŠ¶æ…‹ç®¡ç†ã«ä¾å­˜ã›ãšã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤ï¼ˆfetchï¼‰ã‹ã‚‰ã‚­ãƒ£ãƒƒãƒã—ãŸæƒ…å ±ã‚’å–å¾—ã™ã‚‹ã€‚

```javascript
const patientUuid = HenryCore.getPatientUuid();
// æ³¨æ„: æ‚£è€…ç”»é¢ã‚’ä¸€åº¦ã‚‚é–‹ã„ã¦ã„ãªã„ã€ã¾ãŸã¯é¸æŠè§£é™¤æ™‚ã¯ null
```

### è‡ªèº«ã®UUID: getMyUuid

HenryCore v2.6.0 ä»¥é™ã§ä½¿ç”¨å¯èƒ½ã€‚ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆåŒ»å¸«ï¼‰ã®UUIDã‚’å–å¾—ã™ã‚‹ã€‚

```javascript
const myUuid = await HenryCore.getMyUuid();
if (!myUuid) {
  console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  return;
}
```

---

## 7. Tampermonkey ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å¯¾ç­–

### unsafeWindow ã®ä½¿ç”¨

`@grant GM_*` ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€`unsafeWindow` çµŒç”±ã§ HenryCore ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚

```javascript
// ==UserScript==
// @grant        GM_download
// ==/UserScript==

(async function() {
  const pageWindow = typeof unsafeWindow !== 'undefined' ? unsafeWindow : window;
  
  // HenryCore å¾…æ©Ÿãƒ­ã‚¸ãƒƒã‚¯...
  const core = pageWindow.HenryCore;
})();
```

---

## 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ & ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã®è€ƒæ…® (Pure Functions)

è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã¯ DOM ã‚„ window ã«ä¾å­˜ã—ãªã„ç´”ç²‹é–¢æ•°ã¨ã—ã¦åˆ‡ã‚Šå‡ºã™ã“ã¨ã‚’æ¨å¥¨ã™ã‚‹ã€‚

```javascript
// âŒ NG: DOMä¾å­˜ãŒæ··ã–ã£ã¦ã„ã‚‹
function calculateAge() {
  const text = document.querySelector('#birth').innerText;
  return new Date().getFullYear() - new Date(text).getFullYear();
}

// âœ… OK: ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦è¨ˆç®—ã™ã‚‹ã ã‘ï¼ˆãƒ†ã‚¹ãƒˆå¯èƒ½ï¼‰
function calculateAge(birthDateString) {
  return new Date().getFullYear() - new Date(birthDateString).getFullYear();
}
```

### ãƒãƒƒãƒå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆé€£ç¶šAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰

å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹å ´åˆï¼ˆä¸€æ‹¬æ‰¿èªã€ä¸€æ‹¬æ›´æ–°ãªã©ï¼‰ã€ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã†ã€‚

#### åŸºæœ¬æ§‹é€ 

```javascript
const BASE_DELAY = 150;  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ï¼ˆmsï¼‰
const MAX_DELAY = 5000;  // æœ€å¤§ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆmsï¼‰

async function batchProcess(items, abortSignal, onProgress) {
  let processed = 0;
  let successCount = 0;
  let errorCount = 0;
  let delay = BASE_DELAY;

  for (const item of items) {
    // ä¸­æ­¢ãƒã‚§ãƒƒã‚¯
    if (abortSignal.aborted) {
      return { processed, successCount, errorCount, aborted: true };
    }

    try {
      await processItem(item);
      successCount++;
      delay = BASE_DELAY;  // æˆåŠŸæ™‚ã¯ãƒªã‚»ãƒƒãƒˆ
    } catch (e) {
      errorCount++;
      console.error(`[SCRIPT_NAME] ã‚¨ãƒ©ãƒ¼:`, e.message, { item });

      // ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆ429/503 æ™‚ï¼‰
      if (e.message.includes('429') || e.message.includes('503')) {
        delay = Math.min(delay * 2, MAX_DELAY);
      }
    }

    processed++;
    onProgress({ processed, successCount, errorCount });

    await HenryCore.utils.sleep(delay);
  }

  return { processed, successCount, errorCount, aborted: false };
}
```

#### ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»˜ããƒãƒƒãƒå‡¦ç†

```javascript
async function batchProcessWithPagination(fetchPage, processItem, abortSignal, onProgress) {
  let pageToken = '';

  while (true) {
    if (abortSignal.aborted) break;

    const result = await fetchPage(pageToken);
    const items = result.items || [];

    for (const item of items) {
      // ... ä¸Šè¨˜ã¨åŒæ§˜ã®å‡¦ç†
    }

    // æ³¨æ„: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ç¢ºèªï¼ˆpageToken vs nextPageTokenï¼‰
    pageToken = result.nextPageToken || '';
    if (!pageToken) break;
  }
}
```

#### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹éš›ã®ç¢ºèªäº‹é …ï¼š

- [ ] ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ã‚’è¨­ã‘ã¦ã„ã‚‹ã‹ï¼ˆæœ€ä½100-150msæ¨å¥¨ï¼‰
- [ ] 429/503 ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒãƒƒã‚¯ã‚ªãƒ•ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‹
- [ ] ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç¶šè¡Œã™ã‚‹è¨­è¨ˆã‹
- [ ] AbortController ã«ã‚ˆã‚‹ä¸­æ­¢æ©Ÿèƒ½ãŒã‚ã‚‹ã‹
- [ ] é€²æ—è¡¨ç¤ºï¼ˆå‡¦ç†æ¸ˆã¿/ã‚¨ãƒ©ãƒ¼ä»¶æ•°ï¼‰ã‚’è¡Œã£ã¦ã„ã‚‹ã‹
- [ ] ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ç¢ºèªã—ãŸã‹ï¼ˆ`pageToken` vs `nextPageToken`ï¼‰
- [ ] å¤§é‡å‡¦ç†ã®å ´åˆã€æ¨å®šæ™‚é–“ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‹

---

## 9. ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™»éŒ² (Plugin Registration)

### æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³: registerPlugin

HenryCore v2.6.0 ä»¥é™ã§ã¯ã€`HenryCore.registerPlugin()` ã‚’ä½¿ç”¨ã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€HenryToolbox ã®å¾…æ©Ÿã‚„ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨ç¢ºèªã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆå´ã§è¨˜è¿°ã™ã‚‹å¿…è¦ãŒãªããªã‚‹ã€‚

```javascript
async function init() {
  // HenryCore ã®å¾…æ©Ÿï¼ˆã“ã‚Œã¯å¿…é ˆï¼‰
  const ready = await waitForHenryCore();
  if (!ready) return;

  // ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã§ç™»éŒ²ï¼ˆToolboxå¾…æ©Ÿã¯å†…éƒ¨ã§è‡ªå‹•å‡¦ç†ã•ã‚Œã‚‹ï¼‰
  const registered = await HenryCore.registerPlugin({
    label: 'ğŸ“¤ æ‚£è€…æƒ…å ±ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ',
    event: 'henry:patient-export',
    order: 20
  });
  
  if (!registered) return;

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  window.addEventListener('henry:patient-export', handleExport);
}
```

### ç™»éŒ²ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å‹ | å¿…é ˆ | èª¬æ˜ |
|-----------|-----|------|------|
| `label` | string | âœ… | ãƒœã‚¿ãƒ³ã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆçµµæ–‡å­—å¯ï¼‰ |
| `event` | string | âœ… | ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç™ºç«ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆå (`henry:` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹æ¨å¥¨) |
| `order` | number | - | è¡¨ç¤ºé †åºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100ã€å°ã•ã„ã»ã©ä¸Šï¼‰ |

### å¾Œæ–¹äº’æ›æ€§

HenryCore v2.5.0 ä»¥å‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ`waitForGlobal` + æ‰‹å‹• registerï¼‰ã‚‚å¼•ãç¶šãå‹•ä½œã™ã‚‹ã€‚æ—¢å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¿®æ­£ã¯å¿…é ˆã§ã¯ãªã„ã€‚

---

## 10. UI System (HenryUI)

### åŸºæœ¬ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```javascript
// ãƒœã‚¿ãƒ³
const btn = HenryCore.ui.createButton({
  label: 'ä¿å­˜',
  variant: 'primary', // 'primary' | 'secondary'
  icon: 'save',
  onClick: () => { ... }
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«
const modal = HenryCore.ui.showModal({
  title: 'ç¢ºèª',
  content: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
  actions: [
    { label: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', variant: 'secondary' },
    { label: 'å‰Šé™¤', onClick: handleDelete }
  ]
});
```

---

## 11. ã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³é€£æº (Cross-Domain Integration)

äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ãªã©åˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã®é€£æºæ™‚ã¯ã€`GM_setValue` / `GM_getValue` ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¨IndexedDBã®åˆ¶é™ã«æ³¨æ„ã™ã‚‹ã€‚

### å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

1. Henryå´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ `GM_setValue` ã«ä¿å­˜
2. åˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³å´ã§ `GM_getValue` ã§ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
3. `GM_xmlhttpRequest` ã§ Henry API ã‚’å®Ÿè¡Œ

### ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ¨å¥¨ï¼‰

ã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³é€šä¿¡ã§ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ä½¿ã†å‰ã«ã€`GM_addValueChangeListener` ã‚’æ¤œè¨ã™ã‚‹ã€‚

```javascript
// @grant GM_addValueChangeListener  â† ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ å¿…é ˆ

// âŒ NG: ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆç„¡é§„ãŒå¤šã„ï¼‰
setInterval(() => {
  const val = GM_getValue('refresh_request');
  if (val?.timestamp > lastCheck) { /* å‡¦ç† */ }
}, 1000);

// âœ… OK: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ï¼ˆå¤‰æ›´æ™‚ã®ã¿ç™ºç«ã€è² è·ã‚¼ãƒ­ï¼‰
GM_addValueChangeListener('refresh_request', (name, oldVal, newVal, remote) => {
  if (remote && newVal) {  // remote = åˆ¥ã‚¿ãƒ–ã‹ã‚‰ã®å¤‰æ›´
    handleRefresh(newVal);
  }
});
```

| æ–¹å¼ | æ¤œçŸ¥é€Ÿåº¦ | CPUè² è· |
|------|----------|---------|
| ãƒãƒ¼ãƒªãƒ³ã‚° | æœ€å¤§Nç§’é…å»¶ | å¸¸æ™‚ç™ºç”Ÿ |
| ValueChangeListener | å³åº§ | ã»ã¼ã‚¼ãƒ­ |

### ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆåŒæ–¹å‘ï¼‰

ä¸€æ–¹å‘ã®é€šçŸ¥ã§ã¯ãªãã€å¿…è¦ãªã¨ãã«ãƒ‡ãƒ¼ã‚¿ã‚’è¦æ±‚ã™ã‚‹åŒæ–¹å‘ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚

#### è¦æ±‚å´ï¼ˆä¾‹: Google Docsï¼‰

```javascript
// @grant GM_addValueChangeListener
// @grant GM_removeValueChangeListener

function requestFreshToken(timeout = 3000) {
  return new Promise((resolve) => {
    const requestId = Date.now() + Math.random();
    let resolved = false;
    
    // å¿œç­”ã‚’ç›£è¦–
    const listenerId = GM_addValueChangeListener('henry_auth_token', (name, oldVal, newVal, remote) => {
      if (resolved) return;
      if (remote && newVal?.requestId === requestId) {
        resolved = true;
        GM_removeValueChangeListener(listenerId);
        resolve(newVal.token);
      }
    });
    
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ï¼ˆå¿œç­”å´ã‚¿ãƒ–ãŒé–‰ã˜ã¦ã„ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    setTimeout(() => {
      if (resolved) return;
      resolved = true;
      GM_removeValueChangeListener(listenerId);
      resolve(GM_getValue('henry_auth_token')?.token || null);
    }, timeout);
    
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
    GM_setValue('token_request', { requestId });
  });
}
```

#### å¿œç­”å´ï¼ˆä¾‹: Henryï¼‰

```javascript
GM_addValueChangeListener('token_request', async (name, oldVal, newVal, remote) => {
  if (!remote || !newVal?.requestId) return;
  
  const token = await HenryCore.getToken();
  GM_setValue('henry_auth_token', {
    token,
    requestId: newVal.requestId,  // è¦æ±‚ã¨å¿œç­”ã‚’ç´ä»˜ã‘
    savedAt: Date.now()
  });
});
```

#### ãƒã‚¤ãƒ³ãƒˆ

| é …ç›® | èª¬æ˜ |
|------|------|
| `requestId` | è¦æ±‚ã¨å¿œç­”ã‚’ç´ä»˜ã‘ã‚‹ä¸€æ„ã®è­˜åˆ¥å­ |
| `remote` ãƒ•ãƒ©ã‚° | ä»–ã‚¿ãƒ–ã‹ã‚‰ã®å¤‰æ›´ã®ã¿å‡¦ç†ï¼ˆè‡ªã‚¿ãƒ–ã®å¤‰æ›´ã¯ç„¡è¦–ï¼‰ |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | å¿œç­”å´ã‚¿ãƒ–ãŒé–‰ã˜ã¦ã„ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| ãƒªã‚¹ãƒŠãƒ¼è§£é™¤ | `GM_removeValueChangeListener` ã§ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ |

#### åˆ©ç‚¹

- å¿…è¦ãªã¨ãã ã‘é€šä¿¡ï¼ˆå®šæœŸãƒãƒ¼ãƒªãƒ³ã‚°ä¸è¦ï¼‰
- å¸¸ã«æ–°é®®ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—å¯èƒ½
- å¿œç­”å´ã‚¿ãƒ–ãŒé–‰ã˜ã¦ã„ã¦ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å‹•ä½œ

---

## 12. Henryå†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆApollo Clientï¼‰

Henryã¯Apollo Clientã§ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚’è¡Œã£ã¦ã„ã‚‹ã€‚å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ç”»é¢ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ãŸã„å ´åˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®refetchãŒå¯èƒ½ã€‚

### Apollo Clientã®ç¢ºèª

```javascript
// DevToolsã§ç¢ºèª
console.log(window.__APOLLO_CLIENT__);  // å­˜åœ¨ã™ã‚Œã°ä½¿ç”¨å¯èƒ½
```

### ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å¼·åˆ¶æ›´æ–°

```javascript
window.__APOLLO_CLIENT__.refetchQueries({
  include: ['ListPatientFiles']
});
```

### ä»–ã®ã‚¯ã‚¨ãƒªã‚’refetchã™ã‚‹å ´åˆ

```javascript
// ã‚¯ã‚¨ãƒªåã¯Networkã‚¿ãƒ–ã®GraphQLãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ç¢ºèª
window.__APOLLO_CLIENT__.refetchQueries({
  include: ['GetPatient', 'ListOrders']  // è¤‡æ•°æŒ‡å®šå¯
});
```

### æ³¨æ„äº‹é …

- `__APOLLO_CLIENT__` ã¯Henryã®å†…éƒ¨å®Ÿè£…ã«ä¾å­˜ã™ã‚‹ãŸã‚ã€å°†æ¥å¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- refetchã¯APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹ãŸã‚ã€é »ç¹ãªå‘¼ã³å‡ºã—ã¯é¿ã‘ã‚‹

---

## 13. DOMç›£è¦–ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é¸æŠ

è¦ç´ ã®å‡ºç¾ã‚„å¤‰åŒ–ã‚’ç›£è¦–ã™ã‚‹æ–¹æ³•ã¯è¤‡æ•°ã‚ã‚‹ã€‚é©åˆ‡ãªæ–¹å¼ã‚’é¸æŠã™ã‚‹ã“ã¨ã€‚

### é¸æŠåŸºæº–

| æ–¹å¼ | ä½¿ã†ã¹ãå ´é¢ | è² è· |
|------|-------------|------|
| MutationObserver | ç‰¹å®šè¦ç´ ã®å¤‰åŒ–ã‚’å³åº§ã«æ¤œçŸ¥ | é«˜ï¼ˆåºƒç¯„å›²ç›£è¦–æ™‚ï¼‰ |
| setInterval | å®šæœŸçš„ãªå­˜åœ¨ç¢ºèªã§ååˆ† | ä½ï¼ˆæ—©æœŸreturnã™ã‚Œã°ï¼‰ |
| waitForElement | ä¸€åº¦ã ã‘å‡ºç¾ã‚’å¾…ã¤ | æœ€å° |

### setInterval ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

```javascript
// âœ… OK: æ—¢ã«å­˜åœ¨ã™ã‚Œã°å³returnï¼ˆè² è·æœ€å°ï¼‰
function ensureButton() {
  if (document.getElementById('my-button')) return;  // â† é‡è¦
  // ãƒœã‚¿ãƒ³ä½œæˆå‡¦ç†...
}
setInterval(ensureButton, 2000);
```

### MutationObserver ã®æ³¨æ„ç‚¹

```javascript
// âš ï¸ æ³¨æ„: subtree: true ã¯è² è·ãŒé«˜ã„
observer.observe(document.body, { 
  childList: true, 
  subtree: true  // â† å…¨ã¦ã®å­å­«è¦ç´ ã‚’ç›£è¦–ï¼ˆé‡ã„ï¼‰
});
```

Google Docsã®ã‚ˆã†ãªãƒªãƒƒãƒãªSPAã§ã¯ã€`subtree: true` ã§æ¯ç§’æ•°åå›ç™ºç«ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚

### åˆ¤æ–­ãƒ•ãƒ­ãƒ¼

1. ä¸€åº¦ã ã‘å¾…ã¦ã°ã„ã„ â†’ `waitForElement`
2. å³åº§ã®æ¤œçŸ¥ãŒå¿…è¦ â†’ MutationObserverï¼ˆç¯„å›²ã‚’é™å®šï¼‰
3. æ•°ç§’ã®é…å»¶ãŒè¨±å®¹ã§ãã‚‹ â†’ setIntervalï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
4. ä¸¡æ–¹ä½¿ã£ã¦ã‚‹ â†’ **æœ¬å½“ã«å¿…è¦ã‹è¦‹ç›´ã™**

---

## å¤‰æ›´å±¥æ­´

| Version | Date | Changes |
|---------|------|---------|
| v3.21 | 2026-01-02 | Â§11ã€Œã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³é€£æºã€æ‹¡å¼µ: ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆåŒæ–¹å‘ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰è¿½åŠ  |
| v3.20 | 2026-01-01 | Â§11ã€Œã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³é€£æºã€æ‹¡å¼µ: `GM_addValueChangeListener` ã«ã‚ˆã‚‹ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ ã€‚Â§12ã€ŒHenryå†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆApollo Clientï¼‰ã€æ–°è¦è¿½åŠ ã€‚Â§13ã€ŒDOMç›£è¦–ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é¸æŠã€æ–°è¦è¿½åŠ  |
| v3.19 | 2026-01-01 | HenryCore v2.6.0 å¯¾å¿œ: `registerPlugin` (ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ç™»éŒ²), `getMyUuid` è¿½åŠ ã€‚æ”¹å–„: å‹å®šç¾©ã€PIIä¿è­·è¦å®šã€ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æŒ‡é‡ã‚’è¿½åŠ  |
| v3.18 | 2025-01-01 | Â§8ã€Œãƒãƒƒãƒå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ã€è¿½åŠ ï¼ˆé€£ç¶šAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãƒãƒƒã‚¯ã‚ªãƒ•ã€ä¸­æ­¢æ©Ÿèƒ½ï¼‰ |
| v3.17 | 2025-01-01 | Â§10ã€ŒHenryToolbox ã®å¾…æ©Ÿãƒ‘ã‚¿ãƒ¼ãƒ³ã€è¿½åŠ  â†’ **v3.19 ã§ `registerPlugin` ã«çµ±åˆ** |
| v3.16 | 2025-01-01 | åºç« ã«ã€Œã‚³ãƒ¼ãƒ‰å‡ºåŠ›ã®é †åºã€è¿½åŠ  |
| v3.15 | 2024-12-31 | Â§12ã€Œã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³é€£æºã€è¿½åŠ  |
| v3.10 | 2024-12-31 | Â§11ã€ŒUI System (HenryUI)ã€è¿½åŠ  |
