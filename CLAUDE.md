# Henry EMR 開発ガイドライン (Core Rules v4.11)

<!-- 📝 UPDATED: v4.11 - スピードより確認の正確さを優先するルール追加 -->

> このドキュメントはAIアシスタントとの協働開発における必須ルール集です。HenryCore APIの詳細は `henry_core.user.js` 冒頭のAPI目次と実装を参照。

---

## 1. AI協働開発のルール (AI Collaboration Protocol)

### コミュニケーション方針

#### 曖昧な依頼を受けたときの振る舞い

推測で作業を進める前に、以下の観点で不明確な点があれば質問する：

1. **目的・背景**: なぜこれが必要か？何を解決したいのか？
2. **スコープ**: どこまでやるか？既存コードへの影響範囲は？
3. **制約条件**: 使ってはいけない技術、変更してはいけない部分
4. **出力形式**: コードだけ？説明付き？ファイル分割の粒度は？
5. **優先順位**: 速度重視？保守性重視？完璧さより動くもの優先？

#### 質問の仕方

- 一度に聞くのは**最大2〜3個**に絞る
- Yes/Noや選択肢で答えられる形式を優先する
- 「AとBどちらがいいですか？」「○○という理解で合っていますか？」
- 自分の推測や仮定を示した上で確認を求める

#### 質問すべきタイミング

- 複数の実装アプローチがあり、どれが好みか不明なとき
- 既存のコード規約やパターンと異なる方法を取りそうなとき
- 作業範囲が大きく、方向性を間違えると手戻りが大きいとき
- 要件に矛盾や不整合がありそうなとき

#### 質問しなくてよいとき

- 明らかに些細な実装詳細（変数名の細かい違いなど）
- 過去の会話やこのドキュメントから判断できること
- 標準的なベストプラクティスで対応できること

#### 作業前の確認テンプレート

大きめのタスクを始める前に、以下を簡潔に提示して確認を取る：

```
【理解した内容】
- 目的: ○○
- やること: ○○
- やらないこと: ○○
- 使う技術/パターン: ○○

これで進めてよいですか？
```

#### フィードバックの求め方

作業完了後、必要に応じて：
- 「期待と違う点があれば教えてください」
- 「この方針で他の部分も進めてよいですか？」

作業中は、要所で「何をしようとしているか」「なぜそうするのか」を簡潔に説明すること。

#### クラッシュ報告時の対応

**YOU MUST**: ユーザーから「クラッシュした」と報告を受けた場合は、まず (1) どこまで作業が完了しているか確認し、(2) 残りの作業を明確にしてから再開すること。

### ガイドラインの更新

**YOU MUST**: ユーザーから新しいルールの追加指示があった場合、必ず **カスタムルール** セクションに追記すること。

### プロンプト階層 (Instruction Hierarchy)

指示の重要度は3段階で定義されている：

#### NEVER（絶対禁止）

セキュリティ・安全性の境界。例外なし。

- PII（個人情報）を `localStorage`, `IndexedDB`, `GM_setValue` に平文保存してはならない
- トークン等の秘匿情報を `console.log` に出力してはならない
- `.sc-xxxx` などのランダムなクラス名や XPath をセレクタに使用してはならない
- ユーザー操作なしでの自動スクロールやフォーカス奪取をしてはならない

#### YOU MUST（必須要件）

基本的に遵守すべき要件。例外は稀。

- エラー時は必ず `console.error('[SCRIPT_NAME]', ...)` で原因を出力すること
- SPA遷移時には全ての MutationObserver、タイマー、AbortController を破棄すること
- APIレスポンスがエラー/想定外/null の場合は即停止すること（再試行しない）
- バージョン管理はセマンティックバージョニング（x.y.z）に従うこと
- `@match https://henry-app.jp/*` を使用すること

#### IMPORTANT（重要な考慮事項）

推奨事項。状況に応じた判断は許容。

- パフォーマンスのため、一度だけ待つなら `waitForElement` を推奨
- DOM依存を避け、`HenryCore` API経由でデータ取得を推奨
- 純粋関数として切り出すことでテスト容易性を向上
- `data-testid`、`role`、`aria-*` 属性の使用を推奨

### コード出力の制約 (Code Generation Protocol)

**原則**: ユーザーからの明示的な指示（例：「コードを書いて」「実装して」）があるまで、コピー＆ペーストしてそのまま使える「完全な実装コード」を出力してはならない。

**YOU MUST**: コードを修正する前に、まず修正内容をユーザーに確認すること。確認なしに直接編集しない。

**禁止事項**: 議論の途中で、ユーザーが求めていないのに「修正した全体のコードはこちらです」と長いコードブロックを提示すること。

**例外（許可されるコード）**: ロジックや処理の流れを説明するための短いコード片（数行程度のスニペット）や疑似コードは、理解を助けるために積極的に提示してよい。

**判断基準**:

- ✅ OK: 「例えば、このように `filter` を使うイメージです」といった説明用の抜粋
- ❌ NG: 「修正が完了しました。以下のスクリプト全体を貼り付けてください」といった完成品の提示（指示があるまで待機）

### コード出力の順序 (Code Output Order)

**原則**: コードブロックを出力する際は、説明文を**先に**、コードを**最後に**配置する。コードブロックの後に説明文を書かない。

**理由**: コードブロックの後に説明文があると、ユーザーがコピペする際に余計なテキストが混入し、シンタックスエラーの原因となる。

**判断基準**:

- ✅ OK: 説明 → 変更点 → コードブロック（終了）
- ❌ NG: コードブロック → 変更点 → 説明

---

## 2. Henry開発の必須ルール (Core Development Rules)

### 非侵入型UXの徹底

**IMPORTANT**: 「ぼかしオーバーレイ」等の視覚効果を伴うナビゲーションは、ユーザーのクリック操作を起点とする場合のみ許可。

### 停止の原則とログの切り分け

| 視点 | ルール |
|------|--------|
| ユーザー視点 | UIを出さない、操作を継続させない（沈黙して停止） |
| 開発者視点 | `console.error` で原因を特定可能にする |

**補足：停止の統一ルール**

- APIレスポンスがエラー / 想定外の形式 / null の場合も即停止（再試行しない）
- 「静かに終了」= Promise は `resolve(null)` で正常終了させ、呼び出し元で null チェックを行う
- エラーログには必ず `[SCRIPT_NAME]` プレフィックスを付ける
- 同一エラーは1回だけ出力する（ループ内での連打禁止）

### PII（個人情報）の永続化禁止

**NEVER**: `localStorage`, `IndexedDB`, `GM_setValue` 等のブラウザストレージに、患者の氏名・連絡先・カルテ内容などの個人情報を平文で保存すること。

**IMPORTANT**: 一時的なキャッシュが必要な場合は、メモリ上の変数（TTLCacheなど）のみを使用すること。

### クリーンアップ

**YOU MUST**: SPA遷移時（`henry:navigation` / `popstate`）には、全ての MutationObserver、タイマー、非同期処理を完全に破棄すること。

**使用するAPI**:
- `utils.createCleaner()` - 破棄対象の一括管理
- `utils.subscribeNavigation()` - 画面遷移時の自動クリーンアップ

実装例は `henry_core.user.js` を参照。

---

## 3. 基本的なコードパターン (Essential Patterns)

### セレクタ戦略

**YOU MUST**: `data-testid`、`role`、`aria-*` 属性、または不変のテキストコンテンツを基準にすること。

**IMPORTANT**: モーダル等は `document.body` 直下に現れるため、コンテナ外へのフォールバックを許容する設計にすること。

### HenryCore 使用ガイドライン

**前提条件**: HenryCore スクリプトが先に読み込まれていること。

#### 使用すべき場面

| 場面 | 使用するAPI | 理由 |
|------|------------|------|
| GraphQL呼び出し | `query()` | エンドポイント自動判別、エラー自動ログ |
| 患者UUID取得 | `getPatientUuid()` | DOM解析より確実、タイミング問題を回避 |
| SPA遷移時のクリーンアップ | `utils.createCleaner()` | メモリリーク・二重実行防止 |
| プラグイン登録 | `registerPlugin()` | Toolbox自動連携 |
| Google API連携 | `modules.GoogleAuth` | トークン管理の一元化 |

#### 禁止事項

**NEVER**:
- 直接 `fetch()` でGraphQL APIを呼ぶ → `query()` を使う
- URLやDOMから患者UUIDを解析する → `getPatientUuid()` を使う
- `HenryToolbox.register()` を直接呼ぶ → `registerPlugin()` を使う
- トークン等の秘匿情報をログ出力する
- ハッシュ方式（APQ）でGraphQL APIを呼ぶ → フルクエリ方式を使う

#### エラーハンドリング

**YOU MUST**: `query()` は失敗時に例外を投げる。try-catchで処理し、静かに終了すること。

```javascript
try {
  const result = await HenryCore.query(QUERY, { input: { uuid } });
  if (!result.data?.getPatient) return null;
} catch (e) {
  console.error('[SCRIPT_NAME]', e.message);
  return null;
}
```

#### API詳細

`henry_core.user.js` 冒頭のAPI目次と各関数の実装を参照。

### Tampermonkey スクリプト作成

#### サンドボックス対策

**YOU MUST**: `@grant GM_*` を使用する場合、`@grant unsafeWindow` も追加し、`unsafeWindow` 経由で HenryCore にアクセスすること。

```javascript
const pageWindow = typeof unsafeWindow !== 'undefined' ? unsafeWindow : window;
const core = pageWindow.HenryCore;
```

#### メタデータ設定

**YOU MUST**: 新規スクリプト作成時は以下を設定すること：
- `@updateURL` と `@downloadURL` にGitHub raw URL（`https://raw.githubusercontent.com/shin-926/Henry/main/<filename>.user.js`）
- `@version` をセマンティックバージョニング形式（x.y.z）

**YOU MUST**: コミット時は `@version` を更新（バグ修正: パッチ、機能追加: マイナー、破壊的変更: メジャー）

---

## 4. デバッグとワークフロー (Debug & Workflow)

### デバッグ手順（原因究明ファースト）

1. **現状把握**: ログの確認、無言停止の確認
2. **要因切り分け**: DOM変化、非同期タイミング、データ不整合
3. **仮説検証**: 根拠のある修正のみを行う

**YOU MUST**: エラー発生時は、推測で別の可能性を提案する前に、まず実際のエラー内容を調査すること。APIエラーならレスポンスボディを確認し、具体的なエラーメッセージに基づいて修正する。

### 推奨ワークフロー

**Explore → Plan → Code → Commit**

1. **Explore**: 関連ファイルを読み、既存の実装パターンを理解
2. **Plan**: 詳細な実装計画を立て、ユーザーに確認
3. **Code**: 計画に基づいて実装
4. **Commit**: テスト・確認後にコミット

**IMPORTANT**: 探索・計画をスキップして直接コードを書くと品質が低下する。

### 問題解決のアプローチ (Problem-Solving Approach)

複雑な問題に取り組む際は、以下のプロセスを明示的に踏むこと：

1. **問題の分解**: 大きな問題を小さな部分問題に分ける
2. **仮定の明示**: 前提条件や制約を言語化する
3. **複数案の検討**: 1つの解法に飛びつかず、少なくとも2つのアプローチを比較する
4. **段階的な検証**: 各ステップの結果を確認してから次へ進む

**IMPORTANT**: 「とりあえず動くコードを書く」前に、上記のプロセスを経ること。特に以下の場合は必須：
- バグの原因が不明なとき
- 複数の実装方法があるとき
- 要件が複雑または曖昧なとき

**理由**: 中間推論を明示することで論理の飛躍を防ぎ、手戻りを減らす。

---

## 5. 参照ドキュメント (Reference)

### HenryCore API

`henry_core.user.js` 冒頭のAPI目次と各関数の実装を参照。

**YOU MUST**: APIを変更・追加した場合は、`henry_core.user.js` 冒頭のAPI目次を更新すること。

### GraphQL API

`HENRY-GRAPHQL-API-REFERENCE.md` を参照。

### 調査メモ・実装詳細

`NOTES.md` - 調査結果、API仕様メモ、実装詳細など。保留タスクの詳細情報もここに記載。

### chrome-devtools-mcp（ブラウザ連携）

`NOTES.md` の「chrome-devtools-mcp 起動手順」セクションを参照。

**機能**: Claude Codeがブラウザを直接操作・監視できる
- DOM確認、ボタンクリック、フォーム入力
- ネットワークリクエストのキャプチャ（GraphQL API調査）
- コンソール出力の確認（スクリプト動作確認）

**YOU MUST**: ユーザーから「chrome-devtoolsの起動方法」を聞かれたら、`NOTES.md` の手順を参照して回答すること。

### バージョン管理

**YOU MUST**: 全てのスクリプトはセマンティックバージョニング（x.y.z）に従うこと。

**YOU MUST**: Henry Core の仕様変更に対応した場合は、必ずバージョンを上げること（例: パッチバージョン z の加算）。

---

## 6. カスタムルール (Custom Rules)

> **📝 このセクションは追記専用**: プロジェクト固有のルールや、開発中に追加したいルールをここに記載します。

### 追加ルール

- **IMPORTANT**: コード固有の課題やTODOは、該当コード内にTODOコメントとして残すこと（例: `// TODO: 動作確認後にこのログを削除`）

- **IMPORTANT**: 作業完了後、一段上の視点（メタな視点）から影響範囲を確認し、必要な追加作業があればユーザーに提案すること。コード・ドキュメント・設計方針・運用フロー・命名規則など、あらゆる側面で整合性を考える。

- **YOU MUST**: APIを使用する前に、必ずリファレンスで仕様を確認すること：
  - GraphQL API → `HENRY-GRAPHQL-API-REFERENCE.md` でレスポンス構造・型名・必須フィールドを確認
  - HenryCore API → `henry_core.user.js` 冒頭のAPI目次と実装を確認（プロパティ名、関数の有無など）
  - リファレンスに情報がない場合は、ユーザーに実際のカルテ操作で確認を依頼する
  - **推測でコードを書かない。スピードより確認の正確さを優先する**

---

## 変更履歴

| Version | Date | Changes |
|---------|------|---------|
| v4.11 | 2026-01-12 | スピードより確認の正確さを優先するルール追加 |
| v4.10 | 2026-01-12 | API使用前のリファレンス確認ルール追加（GraphQL/HenryCore両方） |
| v4.9 | 2026-01-12 | タスクID運用ルール追加、メタ視点確認ルール追加 |
| v4.8 | 2026-01-12 | ドキュメント構造簡略化、調査メモをNOTES.mdに分離 |
| v4.7 | 2026-01-11 | 問題解決のアプローチ追加 |
| v4.4 | 2026-01-08 | コミュニケーション方針を詳細化 |
| v4.0 | 2026-01-04 | ルールとリファレンスを分離、プロンプト階層導入 |

> 詳細な変更履歴は `git log` を参照。

---

## 🔔 保留中のタスク (Pending Tasks)

> **AI向け指示**: セッション開始時に確認し、未完了タスクをリマインドすること。タスク完了時はこのセクションを更新すること。
>
> **タスクID運用ルール**:
> - 新規タスク追加時は `TASK-XXX` 形式のIDを振る（連番）
> - 詳細が必要なタスクは `NOTES.md` に同じIDで見出しを作成
> - これにより両ファイル間で `TASK-XXX` で検索して対応を取れる

### 調査・開発タスク
- [ ] TASK-001: ORDER_STATUS_REVOKED の承認API特定
- [ ] TASK-002: 独自オーダーセット選択UI
- [ ] TASK-003: 病名サジェスト機能
- [ ] TASK-011: henry_karte_history 処方表示改善（mhlwMedicine対応、medicationTiming用法取得、検体検査フィールド調査）

### API収集
- [ ] TASK-004: 患者保険・資格画面を操作
- [ ] TASK-005: 注射オーダーを操作
- [ ] TASK-006: 外来会計画面を操作

### 動作確認待ち
- [ ] TASK-007: henry_disease_register.user.js v1.0.0
- [ ] TASK-008: henry_error_logger.user.js v1.0.0
- [ ] TASK-009: HenryCore v2.10.4 エンドポイント自動復旧機能

### 完了
- [x] TASK-010: henry_disease_list.user.js v1.0.2
