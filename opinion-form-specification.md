# 主治医意見書入力フォーム 完全仕様書

**Version**: 1.0
**Date**: 2026-01-05
**Total Items**: 108項目

---

## 📋 基本情報

### データソース
- **フォーム仕様**: `https://docs.google.com/spreadsheets/d/1e-2aPSkWi4bLW1KtaebgWvwe9JXIPdn38Hm7anVV4Q4`
- **CSV標準フォーマット**: `/Users/shinichiro/Downloads/s-iken-csv-ver1.3.pdf`
- **JSONスキーマ**: `opinion-form-schema.json`
- **プレースホルダーマッピング**: `opinion-form-placeholder-mapping.json`

---

## 🎨 入力形式の種類

### 1. 自動入力（19項目）
患者情報・医師情報・医療機関情報をHenryCore APIから自動取得

**自動入力項目一覧:**
- 記入日、患者名かな、患者名、生年月日、年齢、性別
- 郵便番号、住所、連絡先電話番号
- 医師氏名、医療機関名、医療機関郵便番号
- 医療機関所在地、医療機関電話番号、医療機関FAX番号
- 同意の有無（デフォルト値）、最終診察日、意見書作成回数、他科受診有無

### 2. ラジオボタン（33項目）
単一選択。CSV Ver.1.3に従い、左から順に番号を割り当て。

**値マッピング例:**
- 寝たきり度: 自立=1, J1=2, J2=3, A1=4, A2=5, B1=6, B2=7, C1=8, C2=9
- 認知症高齢者の日常生活自立度: 自立=1, Ⅰ=2, Ⅱa=3, Ⅱb=4, Ⅲa=5, Ⅲb=6, Ⅳ=7, M=8
- 同意の有無: 同意する=1, 同意しない=2
- サービス提供系（血圧、摂食、嚥下、移動、運動）: 特になし=1, あり=2

### 3. チェックボックス（21項目）
複数選択。左から順にビットフラグとして保存（例: `"1111110000001"`）

**主要項目:**
- 他科名（13桁）
- 処置内容（9桁）
- 特別な対応（2桁）
- 周辺症状詳細（12桁）
- 発生可能性状態（14桁）
- 医学的管理の必要性（11桁）

### 4. 記述（34項目）
テキスト入力。文字数制限あり/なし。

**文字数制限:**
- `{{経過及び治療内容}}`: 560文字/5行
- `{{その他特記事項}}`: 700文字/10行
- その他の記述項目: 制限なし

### 5. カレンダー（1項目）
日付入力。和暦「令和Y年M月D日」形式に自動変換。

- `{{最終診察日}}`: カレンダー選択 → 和暦変換

---

## 🔧 自動入力仕様

### 患者情報
**取得元**: `HenryCore.getPatientUuid()` → `HenryCore.call('GetPatient', { input: { uuid } })`

**自動入力項目:**
- 記入日: 今日の日付（和暦）
- 患者名かな: `patient.nameKana`
- 患者名: `patient.name`
- 生年月日: `patient.birthDate` → 和暦変換
- 年齢: 記入日時点の年齢を計算
- 性別: `patient.sex`（1:男, 2:女）
- 郵便番号: `patient.postalCode`
- 住所: `patient.address`
- 連絡先電話番号: `patient.phone`

### 医師情報
**取得元**: `HenryCore.getMyUuid()` → **将来のAPI**（現在は未実装）

**TODO**: HenryCoreに医師名取得APIを追加予定

**一時的な対応**:
- 医師氏名: ログインユーザー名 or 空欄

### 医療機関情報
**ハードコード値:**

```javascript
const INSTITUTION_INFO = {
  name: 'マオカ病院',
  postal_code: '〒760-0052',
  address: '香川県高松市瓦町１丁目12-45',
  phone: '087-862-8888',
  fax: '087-863-0880'
};
```

---

## ✅ バリデーションルール

### 必須項目（条件なし）

以下は常に必須:
- 記入日
- 患者名、患者名かな、生年月日、年齢、性別
- 郵便番号、住所、連絡先電話番号
- 医師氏名、医療機関名、医療機関郵便番号、医療機関所在地、医療機関電話番号、医療機関FAX番号
- **同意の有無**（必須、デフォルトなし）
- 最終診察日
- 意見書作成回数、他科受診有無
- 診断名1、発症年月日1
- 経過及び治療内容
- 寝たきり度、認知症高齢者の日常生活自立度
- 短期記憶、認知能力、伝達能力
- 周辺症状有無、精神神経症状有無、専門医受診有無
- 利き腕、身長、体重、体重の変化
- 屋外歩行、車いすの使用、歩行補助具・装具の使用
- 食事行為、現在の栄養状態
- 生活機能改善見通し

### 任意項目

- 診断名2、発症年月日2、診断名3、発症年月日3
- 栄養・食生活上の留意点、対処方針内容
- **全てのチェックボックス項目**
- **全ての「その他」項目**
- その他特記事項

### 条件付き必須項目

| 条件 | 必須になる項目 |
|------|---------------|
| `{{症状安定性}}` = "不安定"（2） | `{{症状不安定時の具体的状況}}` |
| `{{四肢欠損}}` チェック | `{{四肢欠損部位}}` |
| `{{麻痺}}` チェック | 以下のいずれか:<br>`{{麻痺右上肢}}` + `{{麻痺右上肢程度}}`<br>`{{麻痺左上肢}}` + `{{麻痺左上肢程度}}`<br>`{{麻痺右下肢}}` + `{{麻痺右下肢程度}}`<br>`{{麻痺左下肢}}` + `{{麻痺左下肢程度}}`<br>`{{麻痺その他}}` + `{{麻痺その他部位}}` + `{{麻痺その他程度}}` |
| `{{筋力低下}}` チェック | `{{筋力低下部位}}`<br>`{{筋力低下程度}}` |
| `{{関節拘縮}}` チェック | `{{関節拘縮部位}}`<br>`{{関節拘縮程度}}` |
| `{{関節痛み}}` チェック | `{{関節痛み部位}}`<br>`{{関節痛み程度}}` |
| `{{失調不随意運動}}` チェック | 以下のいずれか:<br>`{{失調不随意運動上肢}}`<br>`{{失調不随意運動下肢}}`<br>`{{体幹}}` |
| `{{褥瘡}}` チェック | `{{褥瘡部位}}`<br>`{{褥瘡程度}}` |
| `{{その他皮膚疾患}}` チェック | `{{その他皮膚疾患部位}}`<br>`{{その他皮膚疾患程度}}` |
| `{{医学的管理の必要性}}` チェック | `{{その他の医学的管理}}` |
| `{{サービス提供血圧}}` = "あり"（2） | `{{サービス提供血圧留意事項}}` |
| `{{サービス提供摂食}}` = "あり"（2） | `{{サービス提供摂食留意事項}}` |
| `{{サービス提供嚥下}}` = "あり"（2） | `{{サービス提供嚥下留意事項}}` |
| `{{サービス提供移動}}` = "あり"（2） | `{{サービス提供移動留意事項}}` |
| `{{サービス提供運動}}` = "あり"（2） | `{{サービス提供運動留意事項}}` |
| `{{感染症有無}}` = "有"（1） | `{{感染症名}}` |

### バリデーションエラー時の挙動

**Googleドキュメント保存時:**
- バリデーションエラーがある場合、**保存を中止**
- エラーのある項目を一覧表示
- ユーザーに修正を促す

**例:**
```
以下の項目に入力エラーがあります：
• 同意の有無: 選択してください
• 麻痺がチェックされていますが、部位と程度が未入力です
• 感染症有無が「有」ですが、感染症名が未入力です
```

---

## 📅 日付・和暦変換

### 和暦変換ロジック

**元号判定:**
- 令和: 2019年5月1日〜
- 平成: 1989年1月8日〜2019年4月30日
- 昭和: 1926年12月25日〜1989年1月7日
- 大正: 1912年7月30日〜1926年12月24日
- 明治: 1868年1月25日〜1912年7月29日

**出力形式:**
- `YYYY-MM-DD` → `令和Y年M月D日`
- 例: `2026-01-05` → `令和8年1月5日`

**TODO**: HenryCoreに和暦変換ユーティリティを追加するか検討中

---

## 💾 下書き保存

### localStorage仕様

**キー**: `henry_opinion_draft_{patientUuid}`

**保存期間**: 30日間（自動削除）

**保存内容:**
```javascript
{
  data: { /* 全108項目のJSONデータ */ },
  savedAt: "2026-01-05T10:30:00.000Z",
  patientName: "患者名"
}
```

**自動削除:**
- スクリプト起動時に、30日以上経過した下書きを自動削除
- 削除件数をコンソールに出力

---

## 📄 Googleドキュメント出力

### 出力方式

**方法**: テンプレートをコピーして使用

**詳細仕様**: フォームUI完成後に検討

**プレースホルダー置換:**
- 日本語プレースホルダー（例: `{{患者名}}`）をJSONデータで置換
- マッピング: `opinion-form-placeholder-mapping.json`

---

## 🔄 データフロー

```
1. ユーザーがHenryToolboxから「主治医意見書」を選択

2. スクリプト起動
   ↓
3. 自動入力
   - 患者情報取得（HenryCore API）
   - 医師情報取得（将来のAPI）
   - 医療機関情報（ハードコード）
   ↓
4. 下書き読み込み
   - localStorage から患者別の下書きを取得
   - 自動入力項目は上書きしない
   ↓
5. フォーム表示（HenryCore.ui.showModal）
   - セクションごとにグルーピング
   - 入力形式に応じたUI要素を生成
   ↓
6. ユーザー入力
   - リアルタイムバリデーション（オプション）
   - 条件付き必須項目の動的制御
   ↓
7. アクション選択

   ┌─────────────────────────────────┐
   │ ボタン: キャンセル / 一時保存 / 保存 │
   └─────────────────────────────────┘
            │              │           │
            ↓              ↓           ↓
        閉じる      localStorage   バリデーション
                      に保存            ↓
                                   エラーあり → 警告表示
                                        │
                                   エラーなし
                                        ↓
                              Googleドキュメント作成
                                        ↓
                                  プレースホルダー置換
                                        ↓
                                      完了
```

---

## 🚀 実装優先順位

### Phase 1: フォームUI実装
1. ✅ JSON構造設計
2. ✅ プレースホルダーマッピング
3. 🔄 フォーム仕様ドキュメント化
4. ⏳ フォームHTML生成
5. ⏳ 自動入力ロジック
6. ⏳ 下書き保存・読み込み

### Phase 2: バリデーション実装
1. ⏳ 必須項目チェック
2. ⏳ 条件付き必須項目チェック
3. ⏳ 文字数制限チェック
4. ⏳ エラー表示UI

### Phase 3: Googleドキュメント連携
1. ⏳ テンプレート設計
2. ⏳ プレースホルダー置換ロジック
3. ⏳ ドキュメント作成・保存

### Phase 4: HenryCore拡張（後日）
1. ⏳ 医師名取得API追加
2. ⏳ 和暦変換ユーティリティ追加

---

## 📝 開発メモ

### TODO項目
- [ ] HenryCoreに医師名取得APIを追加
- [ ] HenryCoreに和暦変換ユーティリティを追加（検討中）
- [ ] Googleドキュメントテンプレートの詳細設計

### 技術的注意点
- チェックボックスのビットフラグは左から順に生成
- ラジオボタンの値はCSV Ver.1.3に厳密に従う
- 改行コードは保存時`\n`、表示時は改行として扱う
- 「その他」項目は記述があれば「あり」、なければ「なし」

---

## 📚 関連ドキュメント

- [JSONスキーマ](./opinion-form-schema.json)
- [データテンプレート](./opinion-form-template.json)
- [プレースホルダー一覧](./opinion-form-placeholders.md)
- [プレースホルダーマッピング](./opinion-form-placeholder-mapping.json)
- [フォーム仕様（Googleスプレッドシート）](https://docs.google.com/spreadsheets/d/1e-2aPSkWi4bLW1KtaebgWvwe9JXIPdn38Hm7anVV4Q4)
